{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "MyBatis XML SQL Injection",
  "scopeName": "mybatis.xml.injection.sql",
  "injectionSelector": "L:text.xml",
  "patterns": [
    {
      "include": "#mybatis-statement-tags"
    }
  ],
  "repository": {
    "mybatis-statement-tags": {
      "patterns": [
        {
          "name": "meta.embedded.block.sql.mybatis",
          "begin": "(<)(select|insert|update|delete)(\\s+[^>]*>)",
          "end": "(</)(select|insert|update|delete)(>)",
          "beginCaptures": {
            "1": {
              "name": "punctuation.definition.tag.begin.xml"
            },
            "2": {
              "name": "entity.name.tag.xml"
            },
            "3": {
              "name": "meta.tag.xml"
            }
          },
          "endCaptures": {
            "1": {
              "name": "punctuation.definition.tag.begin.xml"
            },
            "2": {
              "name": "entity.name.tag.xml"
            },
            "3": {
              "name": "punctuation.definition.tag.end.xml"
            }
          },
          "patterns": [
            {
              "include": "#mybatis-dynamic-tags"
            },
            {
              "include": "#mybatis-parameters"
            },
            {
              "include": "#sql-comments"
            },
            {
              "include": "#sql-keywords"
            },
            {
              "include": "#sql-strings"
            },
            {
              "include": "#sql-operators"
            }
          ]
        }
      ]
    },
    "mybatis-dynamic-tags": {
      "comment": "MyBatis dynamic SQL tags (if, foreach, where, set, trim, choose, when, otherwise, bind, include)",
      "patterns": [
        {
          "name": "meta.tag.xml.mybatis",
          "begin": "(<)(if|foreach|where|set|trim|choose|when|otherwise|bind|include)(\\s+[^>]*)(>|/>)",
          "end": "(</)(if|foreach|where|set|trim|choose|when|otherwise|bind|include)(>)",
          "beginCaptures": {
            "1": {
              "name": "punctuation.definition.tag.begin.xml"
            },
            "2": {
              "name": "entity.name.tag.xml"
            },
            "3": {
              "name": "meta.tag.xml"
            },
            "4": {
              "name": "punctuation.definition.tag.end.xml"
            }
          },
          "endCaptures": {
            "1": {
              "name": "punctuation.definition.tag.begin.xml"
            },
            "2": {
              "name": "entity.name.tag.xml"
            },
            "3": {
              "name": "punctuation.definition.tag.end.xml"
            }
          },
          "patterns": [
            {
              "include": "#sql-keywords"
            },
            {
              "include": "#sql-strings"
            },
            {
              "include": "#mybatis-parameters"
            },
            {
              "include": "#mybatis-dynamic-tags"
            }
          ]
        },
        {
          "name": "meta.tag.xml.mybatis",
          "match": "(<)(if|foreach|where|set|trim|choose|when|otherwise|bind|include)(\\s+[^>]*)(/>)",
          "captures": {
            "1": {
              "name": "punctuation.definition.tag.begin.xml"
            },
            "2": {
              "name": "entity.name.tag.xml"
            },
            "3": {
              "name": "meta.tag.xml"
            },
            "4": {
              "name": "punctuation.definition.tag.end.xml"
            }
          }
        }
      ]
    },
    "mybatis-parameters": {
      "comment": "MyBatis parameters: #{param} and ${param}",
      "patterns": [
        {
          "name": "variable.other.mybatis.parameter",
          "match": "(#|\\$)\\{[^}]+\\}"
        }
      ]
    },
    "sql-comments": {
      "patterns": [
        {
          "name": "comment.line.double-dash.sql",
          "match": "--.*$"
        },
        {
          "name": "comment.block.sql",
          "begin": "/\\*",
          "end": "\\*/"
        }
      ]
    },
    "sql-keywords": {
      "comment": "SQL keywords for multiple database dialects (MySQL, PostgreSQL, Oracle, SQL Server)",
      "patterns": [
        {
          "name": "keyword.other.sql",
          "match": "(?i)\\b(SELECT|FROM|WHERE|AND|OR|NOT|IN|EXISTS|BETWEEN|LIKE|IS|NULL|AS|ON|JOIN|LEFT|RIGHT|INNER|OUTER|CROSS|FULL|UNION|ALL|INTERSECT|EXCEPT|MINUS)\\b"
        },
        {
          "name": "keyword.other.dml.sql",
          "match": "(?i)\\b(INSERT|INTO|VALUES|UPDATE|SET|DELETE|MERGE|UPSERT)\\b"
        },
        {
          "name": "keyword.other.ddl.sql",
          "match": "(?i)\\b(CREATE|ALTER|DROP|TRUNCATE|RENAME|TABLE|VIEW|INDEX|SEQUENCE|DATABASE|SCHEMA|CONSTRAINT|PRIMARY|FOREIGN|KEY|UNIQUE|CHECK|DEFAULT|REFERENCES)\\b"
        },
        {
          "name": "keyword.other.dql.sql",
          "match": "(?i)\\b(GROUP|BY|HAVING|ORDER|ASC|DESC|LIMIT|OFFSET|FETCH|FIRST|NEXT|ROW|ROWS|ONLY|NULLS|LAST)\\b"
        },
        {
          "name": "keyword.other.aggregate.sql",
          "match": "(?i)\\b(COUNT|SUM|AVG|MIN|MAX|DISTINCT|TOP|ROWNUM|PARTITION|OVER|RANK|DENSE_RANK|ROW_NUMBER|LEAD|LAG|NTILE)\\b"
        },
        {
          "name": "keyword.other.function.sql",
          "match": "(?i)\\b(CAST|CONVERT|COALESCE|NULLIF|IFNULL|NVL|NVL2|DECODE|CASE|WHEN|THEN|ELSE|END|CONCAT|SUBSTRING|SUBSTR|TRIM|LTRIM|RTRIM|UPPER|LOWER|LENGTH|REPLACE|DATE|DATETIME|TIMESTAMP|NOW|CURRENT_DATE|CURRENT_TIME|CURRENT_TIMESTAMP|EXTRACT|DATE_FORMAT|TO_CHAR|TO_DATE|TO_NUMBER|ROUND|FLOOR|CEIL|ABS|MOD|POWER|SQRT)\\b"
        },
        {
          "name": "keyword.other.transaction.sql",
          "match": "(?i)\\b(BEGIN|COMMIT|ROLLBACK|SAVEPOINT|TRANSACTION|START|WORK|ISOLATION|LEVEL|READ|WRITE|COMMITTED|UNCOMMITTED|REPEATABLE|SERIALIZABLE)\\b"
        },
        {
          "name": "keyword.other.conditional.sql",
          "match": "(?i)\\b(IF|ELSIF|ELSEIF|ELSE|ENDIF)\\b"
        },
        {
          "name": "keyword.other.datatype.sql",
          "match": "(?i)\\b(INT|INTEGER|BIGINT|SMALLINT|TINYINT|DECIMAL|NUMERIC|FLOAT|DOUBLE|REAL|CHAR|VARCHAR|VARCHAR2|TEXT|BLOB|CLOB|DATE|DATETIME|TIMESTAMP|TIME|BOOLEAN|BOOL|BINARY|VARBINARY|ENUM|SET|JSON|JSONB|XML|UUID|SERIAL|BIGSERIAL|ARRAY)\\b"
        },
        {
          "name": "keyword.other.authorization.sql",
          "match": "(?i)\\b(GRANT|REVOKE|DENY|PRIVILEGES|PERMISSION|ROLE|USER|TO|WITH|OPTION|ADMIN|EXECUTE|USAGE)\\b"
        },
        {
          "name": "keyword.other.special.sql",
          "match": "(?i)\\b(FOR|USING|RETURNING|WITH|RECURSIVE|LATERAL|WINDOW|TABLESAMPLE|BERNOULLI|SYSTEM|MATERIALIZED|REFRESH|CONCURRENTLY)\\b"
        }
      ]
    },
    "sql-strings": {
      "patterns": [
        {
          "name": "string.quoted.single.sql",
          "begin": "'",
          "end": "'",
          "patterns": [
            {
              "name": "constant.character.escape.sql",
              "match": "''|\\\\."
            }
          ]
        },
        {
          "name": "string.quoted.double.sql",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.sql",
              "match": "\\\\\"|\\\\."
            }
          ]
        }
      ]
    },
    "sql-operators": {
      "patterns": [
        {
          "name": "keyword.operator.comparison.sql",
          "match": "(<>|!=|<=|>=|<|>|=)"
        },
        {
          "name": "keyword.operator.arithmetic.sql",
          "match": "(\\+|-|\\*|/|%)"
        },
        {
          "name": "keyword.operator.logical.sql",
          "match": "(?i)\\b(AND|OR|NOT)\\b"
        }
      ]
    }
  }
}
